<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Home Management - Mobile & Visuel</title>
    
    <!-- IcÃ´nes pour le tÃ©lÃ©phone -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/619/619153.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            height: 100vh;
        }

        /* Barre de navigation fixe en bas */
        .bottom-nav {
            padding-bottom: calc(0.8rem + var(--safe-bottom));
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            height: calc(5.5rem + var(--safe-bottom));
        }

        .nav-link-active { color: #059669; }
        .nav-link-active .icon-box { background-color: #ecfdf5; transform: scale(1.1) translateY(-5px); }

        .icon-box {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 50px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-premium {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
            border: 1px solid #f1f5f9;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .safe-top { padding-top: var(--safe-top); }
        
        #main-scroll-area {
            height: calc(100vh - 5.5rem - 4.5rem - var(--safe-top) - var(--safe-bottom));
        }

        .ai-shimmer {
            background: linear-gradient(90deg, #10b981 25%, #34d399 50%, #10b981 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Loader pour le scan */
        .scanning-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .text-secure {
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Ã‰CRAN DE CONNEXION -->
    <div id="login-screen" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-6 text-center">
        <div class="bg-white w-full max-w-md rounded-[3.5rem] p-10 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="bg-emerald-600 w-20 h-20 rounded-3xl flex items-center justify-center text-white text-4xl mx-auto mb-4 shadow-xl">ğŸ </div>
            <h1 class="text-3xl font-black text-slate-900 mb-2">Maison ğŸ‡²ğŸ‡¦</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-10 text-center">Choisissez votre profil</p>
            
            <div id="profile-grid" class="grid grid-cols-2 gap-4 mb-10 text-center">
                <button onclick="preSelect('sanaa')" class="p-6 bg-slate-50 rounded-[2.5rem] flex flex-col items-center gap-2 active:scale-95 transition shadow-sm text-center">
                    <span class="text-4xl text-center">ğŸ‘©â€ğŸ’¼</span>
                    <span class="font-black text-slate-800 text-sm text-center">Sanaa</span>
                </button>
                <button onclick="preSelect('hicham')" class="p-6 bg-slate-50 rounded-[2.5rem] flex flex-col items-center gap-2 active:scale-95 transition shadow-sm text-center text-center">
                    <span class="text-4xl text-center">ğŸ‘¨â€ğŸ’¼</span>
                    <span class="font-black text-slate-800 text-sm text-center">Hicham</span>
                </button>
                <button onclick="preSelect('ismael')" class="p-6 bg-slate-50 rounded-[2.5rem] flex flex-col items-center gap-2 active:scale-95 transition shadow-sm text-center text-center">
                    <span class="text-4xl text-center text-center">ğŸ‘¦</span>
                    <span class="font-black text-slate-800 text-sm text-center">IsmaÃ«l</span>
                </button>
                <button onclick="preSelect('youssef')" class="p-6 bg-slate-50 rounded-[2.5rem] flex flex-col items-center gap-2 active:scale-95 transition shadow-sm text-center text-center text-center text-center">
                    <span class="text-4xl text-center">ğŸ‘¶</span>
                    <span class="font-black text-slate-800 text-sm text-center">Youssef</span>
                </button>
                <button onclick="preSelect('chauffeur')" class="p-6 bg-slate-50 rounded-[2.5rem] flex flex-col items-center gap-2 active:scale-95 transition col-span-2 shadow-sm text-center text-center text-center text-center">
                    <span class="text-4xl text-center">ğŸš</span>
                    <span class="font-black text-slate-800 text-sm text-center">Ã‰quipe Maison</span>
                </button>
            </div>

            <div id="pin-entry" class="hidden fade-in text-center text-center text-center text-center">
                <input type="password" id="pin-input" maxlength="4" inputmode="numeric" onkeyup="if(event.key === 'Enter') verifyPin()" class="w-full text-center text-5xl font-black p-4 border-b-4 border-slate-100 outline-none mb-10 bg-transparent tracking-[0.5em]" placeholder="â€¢â€¢â€¢â€¢">
                <div class="flex gap-4 text-center text-center">
                    <button onclick="backToProfiles()" class="flex-1 py-5 bg-slate-100 text-slate-500 rounded-3xl font-black text-center text-center text-center">âŒ</button>
                    <button onclick="verifyPin()" class="flex-[2] py-5 bg-emerald-600 text-white rounded-3xl font-black shadow-lg text-center text-center">OK âœ…</button>
                </div>
            </div>
            <div id="loading-spinner" class="hidden mt-8 text-emerald-600 font-bold animate-pulse text-sm text-center text-center text-center text-center text-center">Connexion... â˜ï¸</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden flex flex-col h-full overflow-hidden text-left">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-slate-50 px-6 py-4 flex justify-between items-center z-50 safe-top shadow-sm text-left">
            <div class="flex items-center gap-4 text-left">
                <div id="user-avatar-top" class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner text-center text-center">ğŸ‘¤</div>
                <div class="text-left text-left text-left text-left">
                    <p id="user-name-top" class="font-black text-slate-900 text-sm leading-tight text-left">Nom</p>
                    <p id="clock-top" class="text-[10px] font-bold text-emerald-600 uppercase tracking-tighter text-left text-left text-left">00:00 â€¢ CASABLANCA ğŸ‡²ğŸ‡¦</p>
                </div>
            </div>
            <button onclick="logout()" class="w-10 h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-xl text-center text-center">ğŸšª</button>
        </header>

        <!-- CONTENT AREA -->
        <main id="main-scroll-area" class="flex-1 overflow-y-auto no-scrollbar bg-slate-50/50 text-left">
            
            <!-- PAGE: DASHBOARD -->
            <div id="page-dashboard" class="page-content fade-in p-5 space-y-6 text-left">
                <div class="bg-white p-6 rounded-[2.5rem] card-premium text-left">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 text-left">Repas du moment ğŸ¥˜</p>
                    <div class="flex items-center justify-between">
                        <p id="dash-meal" class="font-black text-lg text-slate-800 leading-tight text-secure text-left">Chargement...</p>
                        <span class="text-3xl">ğŸ²</span>
                    </div>
                </div>

                <div class="bg-slate-900 p-10 rounded-[3.5rem] text-white relative overflow-hidden shadow-2xl text-left">
                    <div class="relative z-10 text-left">
                        <h3 class="text-xl font-black mb-1 flex items-center gap-2 text-left">Chef IA âœ¨ ğŸ§‘â€ğŸ³</h3>
                        <p id="ai-status" class="text-slate-400 text-xs mb-6 text-left">Besoin d'une idÃ©e de menu selon vos stocks ?</p>
                        <button onclick="askRecipeAi()" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-xs shadow-lg active:scale-95 transition text-center">Proposer âœ¨</button>
                        <div id="ai-recipe-res" class="hidden mt-6 p-5 bg-white/5 rounded-2xl border border-white/10 text-sm italic text-emerald-50 leading-relaxed text-left"></div>
                    </div>
                </div>

                <div class="space-y-4 text-left text-left">
                    <h3 class="font-black text-slate-900 text-xl text-left">Mots Doux ğŸ“ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</h3>
                    <div id="notes-scroll" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar text-left text-left"></div>
                    <button onclick="openModal('add-note')" class="w-full py-6 bg-white rounded-[2.5rem] border-2 border-dashed border-slate-200 text-slate-400 font-bold text-sm text-center">+ Ã‰crire un mot</button>
                </div>
            </div>

            <!-- PAGE: SOS -->
            <div id="page-sos" class="page-content hidden fade-in p-5 space-y-6 text-left">
                <div class="flex justify-between items-center text-left">
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 text-left">ProblÃ¨me ğŸ› ï¸ ğŸ†˜</h3>
                        <p class="text-slate-400 text-xs text-left">Signaler une panne</p>
                    </div>
                    <button onclick="openModal('add-sos')" class="bg-red-600 text-white px-6 py-4 rounded-2xl font-black text-sm shadow-xl text-center">+ SOS</button>
                </div>
                <div id="sos-list" class="space-y-5 text-left text-left"></div>
            </div>

            <!-- PAGE: ALBUM -->
            <div id="page-album" class="page-content hidden fade-in p-5 space-y-6 text-left">
                <div class="flex justify-between items-end text-left text-left">
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 text-left">Photos ğŸ“· ğŸï¸</h3>
                        <p class="text-slate-400 text-xs text-left">Nos souvenirs</p>
                    </div>
                    <label class="bg-emerald-600 text-white p-5 rounded-[1.5rem] shadow-xl active:scale-95 transition cursor-pointer text-center">
                        ğŸ“¸
                        <input type="file" accept="image/*" class="hidden" onchange="uploadPhoto(event)">
                    </label>
                </div>
                <div id="photo-list" class="grid grid-cols-1 gap-8 text-left text-left text-left"></div>
            </div>

            <!-- PAGE: KIDS -->
            <div id="page-kids" class="page-content hidden fade-in p-5 space-y-6 text-left text-left">
                <h3 class="text-2xl font-black text-slate-900 text-left text-left text-left">Ã‰cole ğŸ’ ğŸ«</h3>
                <div class="flex gap-4 overflow-x-auto pb-6 no-scrollbar text-left text-left text-left" id="kids-meals-scroll"></div>
                <div id="kids-acts-list" class="space-y-4 text-left text-left text-left"></div>
            </div>

            <!-- PAGE: STOCKS -->
            <div id="page-stock" class="page-content hidden fade-in p-5 space-y-6 text-left text-left">
                <div class="flex justify-between items-center text-left text-left text-left">
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 text-left text-left">Cuisine ğŸ“¦ ğŸ›’</h3>
                        <p class="text-slate-400 text-xs text-left">Ce qu'il reste</p>
                    </div>
                    <button onclick="openModal('scan-receipt')" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-xl text-center text-center">SCAN ğŸ§¾</button>
                </div>
                <div id="stock-list-container" class="space-y-4 text-left text-left text-left text-left text-left"></div>
            </div>

            <!-- PAGE: PLUS -->
            <div id="page-more" class="page-content hidden fade-in p-5 space-y-6 text-left">
                <div class="bg-white p-8 rounded-[3rem] card-premium text-left text-left text-left text-left">
                    <h3 class="text-xl font-black text-slate-900 mb-8 flex items-center gap-2 text-left">Points ğŸ† ğŸ¥‡</h3>
                    <div id="scores-box" class="grid grid-cols-2 gap-4 mb-10 text-left text-left"></div>
                    <div id="chores-box" class="space-y-4 text-left text-left text-left"></div>
                </div>
                <div class="bg-white p-8 rounded-[3rem] card-premium text-left text-left text-left text-left text-left">
                    <h3 class="text-xl font-black text-slate-900 mb-6 text-left">Tout le Planning ğŸ¥˜</h3>
                    <div id="meals-global-list" class="space-y-4 text-left text-left"></div>
                </div>
            </div>
        </main>

        <!-- BOTTOM NAV -->
        <nav class="fixed bottom-0 left-0 right-0 bottom-nav flex justify-around items-center px-4 pt-4 z-50 shadow-2xl text-center">
            <button onclick="showPage('dashboard')" id="btn-dashboard" class="flex flex-col items-center gap-1 bottom-nav-active flex-1 text-center">
                <div class="icon-box text-center">ğŸ“Š</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center">Accueil</span>
            </button>
            <button onclick="showPage('album')" id="btn-album" class="flex flex-col items-center gap-1 text-slate-400 flex-1 text-center">
                <div class="icon-box text-center text-center">ğŸ“·</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center">Photos</span>
            </button>
            <button onclick="showPage('sos')" id="btn-sos" class="flex flex-col items-center gap-1 text-slate-400 flex-1 text-center text-center text-center">
                <div class="icon-box text-center text-center text-center">ğŸ› ï¸</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center text-center">Aide</span>
            </button>
            <button onclick="showPage('kids')" id="btn-kids" class="flex flex-col items-center gap-1 text-slate-400 flex-1 text-center text-center text-center text-center text-center">
                <div class="icon-box text-center text-center text-center">ğŸ‘¶</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center text-center text-center">Ã‰cole</span>
            </button>
            <button onclick="showPage('stock')" id="btn-stock" class="flex flex-col items-center gap-1 text-slate-400 flex-1 text-center text-center text-center text-center text-center">
                <div class="icon-box text-center text-center text-center text-center">ğŸ“¦</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center text-center text-center">Stock</span>
            </button>
            <button onclick="showPage('more')" id="btn-more" class="flex flex-col items-center gap-1 text-slate-400 flex-1 text-center text-center text-center text-center text-center text-center">
                <div class="icon-box text-center text-center text-center text-center text-center">âš™ï¸</div>
                <span class="text-[10px] font-black uppercase text-center text-center text-center text-center text-center">Plus</span>
            </button>
        </nav>
    </div>

    <!-- MODAL -->
    <div id="modal-wrapper" class="fixed inset-0 z-[150] hidden items-end justify-center modal-bg fade-in text-left text-left">
        <div class="bg-white w-full max-w-lg rounded-t-[3.5rem] shadow-2xl overflow-hidden safe-area-bottom text-left text-left text-left">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center text-left text-left text-left text-left">
                <h3 id="modal-title-ui" class="text-2xl font-black text-slate-900 text-left text-left text-left text-left">Action</h3>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-full text-xl text-center text-center text-center text-center text-center">&times;</button>
            </div>
            <div id="modal-content-ui" class="p-10 max-h-[75vh] overflow-y-auto no-scrollbar text-left text-left text-left text-left text-left text-left text-left text-left text-left"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-ui" class="fixed top-12 left-1/2 -translate-x-1/2 transform -translate-y-20 opacity-0 transition-all duration-500 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl z-[300] text-xs font-black text-center text-center text-center">
        <span id="toast-msg">Message</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'home-management-maroc';
        const apiKey = "AIzaSyALBlzgrbEiDKcQnE7BIrdvq-JLlcphiRY"; 
        const geminiModel = "gemini-2.5-flash-preview-09-2025";
        const DAYS_FULL = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
        
        const PROFILES = {
            sanaa: { name: "Sanaa", role: "Maman", pin: "1111", avatar: "ğŸ‘©â€ğŸ’¼" },
            hicham: { name: "Hicham", role: "Papa", pin: "1111", avatar: "ğŸ‘¨â€ğŸ’¼" },
            ismael: { name: "IsmaÃ«l", role: "Champion", pin: "0000", avatar: "ğŸ‘¦" },
            youssef: { name: "Youssef", role: "Champion", pin: "3333", avatar: "ğŸ‘¶" },
            chauffeur: { name: "Chauffeur", role: "Logistique", pin: "2222", avatar: "ğŸš" },
            nounou: { name: "Nounou", role: "Aide", pin: "4444", avatar: "ğŸ‘©â€ğŸ¼" }
        };

        let currentUser = null;
        let preSelectedKey = null;
        let globalState = {
            inventory: [{ name: "Lait", qty: 1, min: 4, icon: "ğŸ¥›" }, { name: "Farine", qty: 2, min: 3, icon: "ğŸŒ¾" }],
            activities: [],
            globalMeals: Array(7).fill('Ã€ dÃ©finir ğŸ²'),
            kidsMeals: Array(7).fill('Ã€ dÃ©finir ğŸ±'),
            notes: [{ text: "Bienvenue ! âœ¨", color: "#fef3c7", sender: "SystÃ¨me" }],
            scores: { ismael: 0, youssef: 0 },
            chores: [{ name: "Ranger la chambre", pts: 20, done: false }, { name: "Finir les devoirs", pts: 50, done: false }],
            photos: [],
            problems: []
        };

        // --- IA GEMINI (TEXT & VISION) ---
        async function callGemini(prompt, sys, base64Image = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
            const contents = base64Image ? [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Image } }] }] : [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents, systemInstruction: { parts: [{ text: sys }] } };
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
            }
        }

        // --- NAVIGATION ---
        window.showPage = (id) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(`page-${id}`);
            if(target) target.classList.remove('hidden');
            document.getElementById('main-scroll-area').scrollTo({ top: 0, behavior: 'instant' });
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bottom-nav-active', 'text-emerald-600'));
            const btn = document.getElementById(`btn-${id}`);
            if(btn) btn.classList.add('bottom-nav-active', 'text-emerald-600');
        };

        // --- AUTH & SYNC ---
        window.preSelect = (k) => { preSelectedKey = k; document.getElementById('profile-grid').classList.add('hidden'); document.getElementById('pin-entry').classList.remove('hidden'); document.getElementById('pin-input').focus(); };
        window.backToProfiles = () => { document.getElementById('profile-grid').classList.remove('hidden'); document.getElementById('pin-entry').classList.add('hidden'); };
        window.verifyPin = async () => {
            if(document.getElementById('pin-input').value === PROFILES[preSelectedKey].pin) {
                document.getElementById('loading-spinner').classList.remove('hidden');
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (err) { console.error(err); }
            } else { notify("PIN Incorrect ! âŒ"); document.getElementById('pin-input').value = ""; }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = PROFILES[preSelectedKey];
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initUI(); syncData();
            }
        });

        function syncData() {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_state', 'global_state');
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) { globalState = snap.data(); renderAll(); }
                else setDoc(docRef, globalState);
            });
        }
        async function save() { if (!auth.currentUser) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_state', 'global_state'), globalState); }

        // --- RENDERERS ---
        function renderAll() { renderDashboard(); renderSOS(); renderAlbum(); renderKids(); renderStock(); renderMore(); }

        function renderDashboard() {
            document.getElementById('dash-meal').innerText = globalState.globalMeals[0];
            document.getElementById('notes-scroll').innerHTML = (globalState.notes || []).map(n => `<div class="sticky-note min-w-[200px] p-6 rounded-[2.5rem] text-[11px] font-bold h-40 flex flex-col justify-between text-secure border border-white/50 shadow-lg" style="background-color: ${n.color}"><p class="text-slate-800 leading-tight text-left text-left text-left">${n.text}</p><p class="text-[8px] font-black uppercase opacity-40 text-right">â€” ${n.sender}</p></div>`).join('');
        }

        function renderSOS() {
            document.getElementById('sos-list').innerHTML = (globalState.problems || []).map((p, i) => `
                <div class="bg-white p-6 rounded-[2.5rem] card-premium flex flex-col gap-4 text-left">
                    <div class="flex justify-between items-start text-left text-left">
                        <div class="text-left"><p class="text-[10px] font-black text-slate-400 uppercase text-left text-left">${p.date} â€¢ ${p.sender}</p><h4 class="font-extrabold text-slate-900 text-sm mt-1 text-left text-left">${p.desc}</h4></div>
                        <span class="text-[9px] font-black uppercase px-3 py-1 rounded-full ${p.status === 'RÃ©parÃ©' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'} text-center text-center">${p.status}</span>
                    </div>
                    ${p.photo ? `<img src="${p.photo}" class="w-full h-48 object-cover rounded-3xl">` : ''}
                    ${currentUser.role === 'Maman' || currentUser.role === 'Papa' ? `<button onclick="toggleSOS(${i})" class="w-full py-4 bg-slate-50 rounded-2xl text-[10px] font-black uppercase text-center text-center">Marquer Fait âœ…</button>` : ''}
                </div>`).join('') || '<p class="text-slate-400 text-xs text-center py-10 text-center">Aucun SOS signalÃ©. âœ¨</p>';
        }

        function renderAlbum() {
            document.getElementById('photo-list').innerHTML = (globalState.photos || []).map(p => `<div class="bg-white p-4 rounded-[2.5rem] card-premium flex flex-col gap-4 text-left text-left"><img src="${p.url}" class="rounded-3xl h-64 object-cover"><div class="px-2 text-left text-left"><p class="text-sm font-extrabold text-slate-900 text-left text-left">${p.caption}</p><p class="text-[9px] font-black text-slate-400 uppercase mt-1 text-left text-left">${p.sender}</p></div></div>`).join('');
        }

        function renderKids() {
            document.getElementById('kids-meals-scroll').innerHTML = DAYS_FULL.map((d, i) => `<div onclick="openDayDetail(${i}, 'kids')" class="min-w-[120px] bg-white p-6 rounded-3xl text-center border border-slate-100 shadow-sm text-center text-center"><p class="text-[10px] font-black text-slate-300 uppercase mb-2 text-center">${d.substring(0,3)}</p><p class="text-[12px] font-black text-slate-800 truncate text-center text-center">${globalState.kidsMeals[i]}</p></div>`).join('');
        }

        function renderStock() {
            document.getElementById('stock-list-container').innerHTML = (globalState.inventory || []).map((item, idx) => `<div class="bg-white p-6 rounded-[2.5rem] flex justify-between items-center shadow-sm border border-slate-100 text-left text-left text-left text-left"><div class="flex items-center gap-5 text-left text-left text-left text-left"><span class="text-3xl text-center text-center text-center text-center">${item.icon}</span><p class="font-extrabold text-slate-800 text-sm text-left text-left text-left">${item.name}</p></div><div class="flex items-center gap-4 text-left text-left text-left"><button onclick="updateQty(${idx}, -1)" class="w-10 h-10 bg-slate-100 rounded-xl font-bold text-center text-center">-</button><span class="font-black text-xl ${item.qty < item.min ? 'text-red-500' : 'text-slate-900'} text-center">${item.qty}</span><button onclick="updateQty(${idx}, 1)" class="w-10 h-10 bg-slate-100 rounded-xl font-bold text-center text-center text-center">+</button></div></div>`).join('');
        }

        function renderMore() {
            document.getElementById('scores-box').innerHTML = `<div class="bg-emerald-900 p-8 rounded-[2.5rem] text-white text-center text-center"> <p class="text-[10px] font-black uppercase text-white/50 mb-2 text-center text-center">IsmaÃ«l</p><p class="text-3xl font-black text-center text-center">${globalState.scores.ismael} <span class="text-xs">pts</span></p></div><div class="bg-indigo-900 p-8 rounded-[2.5rem] text-white text-center text-center text-center"> <p class="text-[10px] font-black uppercase text-white/50 mb-2 text-center text-center text-center">Youssef</p><p class="text-3xl font-black text-center text-center text-center">${globalState.scores.youssef} <span class="text-xs text-center text-center">pts</span></p></div>`;
            document.getElementById('chores-box').innerHTML = (globalState.chores || []).map((c, i) => `<div class="flex items-center justify-between p-6 bg-slate-50 rounded-[2.5rem] text-left text-left text-left text-left"><div class="flex items-center gap-4 text-left text-left text-left text-left"><input type="checkbox" ${c.done ? 'checked' : ''} onchange="toggleChore(${i})" class="w-8 h-8 rounded-xl border-slate-200 text-emerald-600 focus:ring-0"><span class="text-sm font-bold ${c.done ? 'line-through text-slate-300' : 'text-slate-800'} text-left text-left text-left">${c.name}</span></div><span class="text-[10px] font-black text-emerald-600 text-right">+${c.pts}</span></div>`).join('');
            document.getElementById('meals-global-list').innerHTML = DAYS_FULL.map((d, i) => `<div onclick="openDayDetail(${i}, 'global')" class="bg-slate-50 p-6 rounded-[2rem] flex justify-between items-center text-left text-left text-left text-left text-left text-left"><div class="text-left text-left text-left text-left"><p class="text-[10px] font-black text-slate-400 uppercase text-left text-left">${d}</p><p class="text-sm font-black text-slate-800 text-left text-left text-left">${globalState.globalMeals[i]}</p></div><span class="text-2xl text-center text-center">ğŸ¥˜</span></div>`).join('');
        }

        // --- ACTIONS ---
        window.updateQty = (idx, v) => { globalState.inventory[idx].qty = Math.max(0, globalState.inventory[idx].qty + v); save(); };
        window.toggleChore = (i) => { globalState.chores[i].done = !globalState.chores[i].done; const target = (currentUser.name === "Youssef") ? "youssef" : "ismael"; globalState.scores[target] += globalState.chores[i].done ? globalState.chores[i].pts : -globalState.chores[i].pts; save(); };
        window.toggleSOS = (i) => { globalState.problems[i].status = globalState.problems[i].status === 'RÃ©parÃ©' ? 'En attente' : 'RÃ©parÃ©'; save(); };

        window.uploadPhoto = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => {
                if(!globalState.photos) globalState.photos = [];
                globalState.photos.unshift({ url: ev.target.result, caption: "Nouveau souvenir ! âœ¨", sender: currentUser.name });
                save(); notify("Photo postÃ©e ! ğŸ“¸");
            }; r.readAsDataURL(f);
        };

        window.processTicketScan = async (event) => {
            const file = event.target.files[0]; if (!file) return;
            const modalContent = document.getElementById('modal-content-ui');
            modalContent.innerHTML = `<div class="flex flex-col items-center justify-center py-10 space-y-4 text-center text-center text-center"><div class="scanning-loader"></div><p class="font-black text-slate-800 text-sm text-center">L'IA analyse votre ticket... ğŸ§¾âœ¨</p></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                const resText = await callGemini("Analyse ce ticket de course. Liste les articles et quantitÃ©s sous JSON: [{'name': 'Nom court', 'qty': nombre}]. Ne rÃ©ponds QUE le JSON.", "Expert en tickets de caisse marocains.", base64);
                try {
                    const cleanJson = resText.replace(/```json|```/g, '').trim();
                    const newItems = JSON.parse(cleanJson);
                    newItems.forEach(item => {
                        const existing = globalState.inventory.find(i => i.name.toLowerCase() === item.name.toLowerCase());
                        if (existing) existing.qty += (item.qty || 1);
                        else globalState.inventory.push({ name: item.name, qty: (item.qty || 1), min: 2, icon: "ğŸ“¦" });
                    });
                    save(); closeModal(); notify("Stock mis Ã  jour ! ğŸ§¾âœ…");
                } catch (err) { closeModal(); notify("Erreur IA âŒ"); }
            };
            reader.readAsDataURL(file);
        };

        window.submitSOS = () => {
            const d = document.getElementById('sos-d').value; const p = document.getElementById('sos-p'); if(!d) return;
            const post = (u = null) => { if(!globalState.problems) globalState.problems = []; globalState.problems.unshift({ desc: d, photo: u, sender: currentUser.name, date: new Date().toLocaleDateString('fr-FR'), status: 'En attente' }); save(); closeModal(); notify("SOS envoyÃ© ! ğŸ› ï¸"); };
            if(p.files[0]) { let r = new FileReader(); r.onload = (e) => post(e.target.result); r.readAsDataURL(p.files[0]); } else post();
        };

        window.askRecipeAi = async () => {
            const el = document.getElementById('ai-recipe-res');
            el.classList.remove('hidden'); el.innerHTML = '<div class="ai-shimmer h-4 w-full rounded text-center text-center"></div>';
            const s = globalState.inventory.filter(i => i.qty > 0).map(i => i.name).join(', ');
            const res = await callGemini(`Stock: ${s}. Recette marocaine trÃ¨s courte.`, "Chef marocain expert.");
            el.innerText = res;
        };

        // --- UTILS ---
        window.closeModal = () => document.getElementById('modal-wrapper').classList.add('hidden');
        window.logout = () => location.reload();

        window.openModal = (type) => {
            const m = document.getElementById('modal-wrapper');
            const c = document.getElementById('modal-content-ui');
            const t = document.getElementById('modal-title-ui');
            m.classList.remove('hidden'); m.classList.add('flex');
            if(type === 'add-note') {
                t.innerText = "Laisser un mot ğŸ“";
                c.innerHTML = `<textarea id="note-t" class="w-full p-8 bg-slate-50 rounded-[2.5rem] mb-6 text-sm font-bold text-left text-left text-left text-left" rows="3" placeholder="Tapez votre message ici..."></textarea><div class="flex gap-5 mb-6 text-left text-left"><button onclick="saveN('#fef3c7')" class="w-14 h-14 rounded-2xl bg-[#fef3c7] border-2 shadow-sm text-center text-center"></button><button onclick="saveN('#dcfce7')" class="w-14 h-14 rounded-2xl bg-[#dcfce7] border-2 shadow-sm text-center text-center text-center"></button><button onclick="saveN('#fee2e2')" class="w-14 h-14 rounded-2xl bg-[#fee2e2] border-2 shadow-sm text-center text-center text-center"></button></div><button onclick="saveN('#ffffff')" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] font-black text-center text-center">VALIDER âœ…</button>`;
            } else if(type === 'add-sos') {
                t.innerText = "Nouveau SOS ğŸ†˜";
                c.innerHTML = `<div class="space-y-6 text-left text-left text-left text-left text-left"><textarea id="sos-d" class="w-full p-8 bg-slate-50 rounded-[2.5rem] text-sm font-bold text-left text-left text-left text-left" rows="3" placeholder="Quel est le souci ?"></textarea><label class="block p-8 border-4 border-dashed border-slate-100 rounded-[2.5rem] text-center cursor-pointer text-center text-center text-center text-center text-center"><span class="text-3xl text-center text-center text-center">ğŸ“¸</span><p class="text-[10px] font-black uppercase text-slate-400 mt-2 text-center text-center text-center text-center text-center text-center">Prendre la photo</p><input type="file" id="sos-p" accept="image/*" capture="camera" class="hidden text-left text-left text-left text-left text-left text-left"></label><button onclick="submitSOS()" class="w-full py-6 bg-red-600 text-white rounded-[2.5rem] font-black shadow-xl text-center text-center text-center text-center">ENVOYER SOS ğŸ› ï¸</button></div>`;
            } else if(type === 'scan-receipt') {
                t.innerText = "Scanner un ticket ğŸ§¾";
                c.innerHTML = `<div class="space-y-6 text-center text-center text-center text-center text-center"><div class="bg-emerald-50 p-10 rounded-[3rem] text-center text-center text-center"><span class="text-6xl text-center text-center">ğŸ§¾</span></div><p class="font-bold text-slate-600 text-center text-center text-center text-center">L'IA va lire les articles du ticket.</p><label class="block w-full py-6 bg-emerald-600 text-white rounded-[2.5rem] font-black shadow-xl cursor-pointer text-center text-center text-center">PRENDRE LA PHOTO ğŸ“¸<input type="file" accept="image/*" capture="camera" class="hidden" onchange="processTicketScan(event)"></label></div>`;
            }
        };

        window.saveN = (col) => {
            const t = document.getElementById('note-t').value; if(!t) return;
            if(!globalState.notes) globalState.notes = [];
            globalState.notes.unshift({ text: t, color: col, sender: currentUser.name });
            save(); closeModal(); notify("Mot ajoutÃ© ! âœ…");
        };

        window.openDayDetail = (idx, type) => {
            const m = document.getElementById('modal-wrapper');
            const c = document.getElementById('modal-content-ui');
            const t = document.getElementById('modal-title-ui');
            m.classList.remove('hidden'); m.classList.add('flex');
            t.innerText = "Changer le menu ğŸ¥˜";
            const val = (type === 'kids') ? globalState.kidsMeals[idx] : globalState.globalMeals[idx];
            c.innerHTML = `<div class="space-y-6 text-left text-left text-left text-left text-left text-left text-left text-left"><label class="text-[10px] font-black text-slate-400 uppercase text-left text-left text-left text-left text-left">Nouveau menu</label><input id="e-m" class="w-full text-2xl font-black border-b-4 py-4 outline-none text-left text-left text-left text-left" value="${val}"><button onclick="saveM(${idx}, '${type}')" class="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black mt-10 text-center text-center text-center text-center">ENREGISTRER âœ¨</button></div>`;
        };

        window.saveM = (i, t) => {
            const v = document.getElementById('e-m').value;
            if(t === 'kids') globalState.kidsMeals[i] = v; else globalState.globalMeals[i] = v;
            save(); closeModal(); notify("Planning Ã  jour !");
        };

        function initUI() {
            document.getElementById('user-name-top').innerText = currentUser.name;
            document.getElementById('user-avatar-top').innerText = currentUser.avatar;
        }

        function notify(m) { 
            const t = document.getElementById('toast-ui'); 
            const msg = document.getElementById('toast-msg');
            if (msg) msg.innerText = m; 
            t.classList.remove('-translate-y-20', 'opacity-0'); 
            setTimeout(() => t.classList.add('-translate-y-20', 'opacity-0'), 3000); 
        }

        setInterval(() => {
            const now = new Date();
            const timeEl = document.getElementById('clock-top');
            if (timeEl) timeEl.innerText = new Intl.DateTimeFormat('fr-FR', { timeZone: 'Africa/Casablanca', hour: '2-digit', minute: '2-digit' }).format(now) + " â€¢ MAROC ğŸ‡²ğŸ‡¦";
        }, 1000);
    </script>
</body>
</html>